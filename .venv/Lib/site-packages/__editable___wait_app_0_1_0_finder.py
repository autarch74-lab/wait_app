from __future__ import annotations
import sys
from importlib.machinery import ModuleSpec, PathFinder
from importlib.machinery import all_suffixes as module_suffixes
from importlib.util import spec_from_file_location
from itertools import chain
from pathlib import Path

MAPPING: dict[str, str] = {
    "android": "C:\\src\\wait_app\\android",
    "backend": "C:\\src\\wait_app\\backend",
    "build": "C:\\src\\wait_app\\build",
    "coverage": "C:\\src\\wait_app\\coverage",
    "ios": "C:\\src\\wait_app\\ios",
    "lib": "C:\\src\\wait_app\\lib",
    "linux": "C:\\src\\wait_app\\linux",
    "macos": "C:\\src\\wait_app\\macos",
    "scripts": "C:\\src\\wait_app\\scripts",
    "test": "C:\\src\\wait_app\\test",
    "web": "C:\\src\\wait_app\\web",
    "windows": "C:\\src\\wait_app\\windows",
}
NAMESPACES: dict[str, list[str]] = {
    "android": ["C:\\src\\wait_app\\android"],
    "build": ["C:\\src\\wait_app\\build"],
    "coverage": ["C:\\src\\wait_app\\coverage"],
    "ios": ["C:\\src\\wait_app\\ios"],
    "lib": ["C:\\src\\wait_app\\lib"],
    "linux": ["C:\\src\\wait_app\\linux"],
    "macos": ["C:\\src\\wait_app\\macos"],
    "scripts": ["C:\\src\\wait_app\\scripts"],
    "test": ["C:\\src\\wait_app\\test"],
    "web": ["C:\\src\\wait_app\\web"],
    "windows": ["C:\\src\\wait_app\\windows"],
    "android.app": ["C:\\src\\wait_app\\android\\app"],
    "android.gradle": ["C:\\src\\wait_app\\android\\gradle"],
    "android.app.src": ["C:\\src\\wait_app\\android\\app\\src"],
    "android.app.src.debug": ["C:\\src\\wait_app\\android\\app\\src\\debug"],
    "android.app.src.main": ["C:\\src\\wait_app\\android\\app\\src\\main"],
    "android.app.src.profile": ["C:\\src\\wait_app\\android\\app\\src\\profile"],
    "android.app.src.main.kotlin": [
        "C:\\src\\wait_app\\android\\app\\src\\main\\kotlin"
    ],
    "android.app.src.main.res": ["C:\\src\\wait_app\\android\\app\\src\\main\\res"],
    "android.app.src.main.kotlin.com": [
        "C:\\src\\wait_app\\android\\app\\src\\main\\kotlin\\com"
    ],
    "android.app.src.main.kotlin.com.example": [
        "C:\\src\\wait_app\\android\\app\\src\\main\\kotlin\\com\\example"
    ],
    "android.app.src.main.kotlin.com.example.wait_app": [
        "C:\\src\\wait_app\\android\\app\\src\\main\\kotlin\\com\\example\\wait_app"
    ],
    "android.app.src.main.res.drawable": [
        "C:\\src\\wait_app\\android\\app\\src\\main\\res\\drawable"
    ],
    "android.app.src.main.res.drawable-v21": [
        "C:\\src\\wait_app\\android\\app\\src\\main\\res\\drawable-v21"
    ],
    "android.app.src.main.res.mipmap-hdpi": [
        "C:\\src\\wait_app\\android\\app\\src\\main\\res\\mipmap-hdpi"
    ],
    "android.app.src.main.res.mipmap-mdpi": [
        "C:\\src\\wait_app\\android\\app\\src\\main\\res\\mipmap-mdpi"
    ],
    "android.app.src.main.res.mipmap-xhdpi": [
        "C:\\src\\wait_app\\android\\app\\src\\main\\res\\mipmap-xhdpi"
    ],
    "android.app.src.main.res.mipmap-xxhdpi": [
        "C:\\src\\wait_app\\android\\app\\src\\main\\res\\mipmap-xxhdpi"
    ],
    "android.app.src.main.res.mipmap-xxxhdpi": [
        "C:\\src\\wait_app\\android\\app\\src\\main\\res\\mipmap-xxxhdpi"
    ],
    "android.app.src.main.res.values": [
        "C:\\src\\wait_app\\android\\app\\src\\main\\res\\values"
    ],
    "android.app.src.main.res.values-night": [
        "C:\\src\\wait_app\\android\\app\\src\\main\\res\\values-night"
    ],
    "android.gradle.wrapper": ["C:\\src\\wait_app\\android\\gradle\\wrapper"],
    "backend.filegen": ["C:\\src\\wait_app\\backend\\filegen"],
    "backend.tests": ["C:\\src\\wait_app\\backend\\tests"],
    "build.android": ["C:\\src\\wait_app\\build\\android"],
    "build.native_assets": ["C:\\src\\wait_app\\build\\native_assets"],
    "build.test_cache": ["C:\\src\\wait_app\\build\\test_cache"],
    "build.unit_test_assets": ["C:\\src\\wait_app\\build\\unit_test_assets"],
    "build.android.app": ["C:\\src\\wait_app\\build\\android\\app"],
    "build.android.gradle": ["C:\\src\\wait_app\\build\\android\\gradle"],
    "build.android.app.src": ["C:\\src\\wait_app\\build\\android\\app\\src"],
    "build.android.app.src.debug": [
        "C:\\src\\wait_app\\build\\android\\app\\src\\debug"
    ],
    "build.android.app.src.main": ["C:\\src\\wait_app\\build\\android\\app\\src\\main"],
    "build.android.app.src.profile": [
        "C:\\src\\wait_app\\build\\android\\app\\src\\profile"
    ],
    "build.android.app.src.main.java": [
        "C:\\src\\wait_app\\build\\android\\app\\src\\main\\java"
    ],
    "build.android.app.src.main.kotlin": [
        "C:\\src\\wait_app\\build\\android\\app\\src\\main\\kotlin"
    ],
    "build.android.app.src.main.res": [
        "C:\\src\\wait_app\\build\\android\\app\\src\\main\\res"
    ],
    "build.android.app.src.main.java.io": [
        "C:\\src\\wait_app\\build\\android\\app\\src\\main\\java\\io"
    ],
    "build.android.app.src.main.java.io.flutter": [
        "C:\\src\\wait_app\\build\\android\\app\\src\\main\\java\\io\\flutter"
    ],
    "build.android.app.src.main.java.io.flutter.plugins": [
        "C:\\src\\wait_app\\build\\android\\app\\src\\main\\java\\io\\flutter\\plugins"
    ],
    "build.android.app.src.main.kotlin.com": [
        "C:\\src\\wait_app\\build\\android\\app\\src\\main\\kotlin\\com"
    ],
    "build.android.app.src.main.kotlin.com.example": [
        "C:\\src\\wait_app\\build\\android\\app\\src\\main\\kotlin\\com\\example"
    ],
    "build.android.app.src.main.kotlin.com.example.wait_app": [
        "C:\\src\\wait_app\\build\\android\\app\\src\\main\\kotlin\\com\\example\\wait_app"
    ],
    "build.android.app.src.main.res.drawable": [
        "C:\\src\\wait_app\\build\\android\\app\\src\\main\\res\\drawable"
    ],
    "build.android.app.src.main.res.drawable-v21": [
        "C:\\src\\wait_app\\build\\android\\app\\src\\main\\res\\drawable-v21"
    ],
    "build.android.app.src.main.res.mipmap-hdpi": [
        "C:\\src\\wait_app\\build\\android\\app\\src\\main\\res\\mipmap-hdpi"
    ],
    "build.android.app.src.main.res.mipmap-mdpi": [
        "C:\\src\\wait_app\\build\\android\\app\\src\\main\\res\\mipmap-mdpi"
    ],
    "build.android.app.src.main.res.mipmap-xhdpi": [
        "C:\\src\\wait_app\\build\\android\\app\\src\\main\\res\\mipmap-xhdpi"
    ],
    "build.android.app.src.main.res.mipmap-xxhdpi": [
        "C:\\src\\wait_app\\build\\android\\app\\src\\main\\res\\mipmap-xxhdpi"
    ],
    "build.android.app.src.main.res.mipmap-xxxhdpi": [
        "C:\\src\\wait_app\\build\\android\\app\\src\\main\\res\\mipmap-xxxhdpi"
    ],
    "build.android.app.src.main.res.values": [
        "C:\\src\\wait_app\\build\\android\\app\\src\\main\\res\\values"
    ],
    "build.android.app.src.main.res.values-night": [
        "C:\\src\\wait_app\\build\\android\\app\\src\\main\\res\\values-night"
    ],
    "build.android.gradle.wrapper": [
        "C:\\src\\wait_app\\build\\android\\gradle\\wrapper"
    ],
    "build.native_assets.windows": ["C:\\src\\wait_app\\build\\native_assets\\windows"],
    "build.test_cache.build": ["C:\\src\\wait_app\\build\\test_cache\\build"],
    "build.unit_test_assets.fonts": [
        "C:\\src\\wait_app\\build\\unit_test_assets\\fonts"
    ],
    "build.unit_test_assets.packages": [
        "C:\\src\\wait_app\\build\\unit_test_assets\\packages"
    ],
    "build.unit_test_assets.shaders": [
        "C:\\src\\wait_app\\build\\unit_test_assets\\shaders"
    ],
    "build.unit_test_assets.packages.cupertino_icons": [
        "C:\\src\\wait_app\\build\\unit_test_assets\\packages\\cupertino_icons"
    ],
    "build.unit_test_assets.packages.cupertino_icons.assets": [
        "C:\\src\\wait_app\\build\\unit_test_assets\\packages\\cupertino_icons\\assets"
    ],
    "ios.Flutter": ["C:\\src\\wait_app\\ios\\Flutter"],
    "ios.Runner": ["C:\\src\\wait_app\\ios\\Runner"],
    "ios.RunnerTests": ["C:\\src\\wait_app\\ios\\RunnerTests"],
    "ios.Flutter.ephemeral": ["C:\\src\\wait_app\\ios\\Flutter\\ephemeral"],
    "lib.modules": ["C:\\src\\wait_app\\lib\\modules"],
    "linux.flutter": ["C:\\src\\wait_app\\linux\\flutter"],
    "linux.runner": ["C:\\src\\wait_app\\linux\\runner"],
    "linux.flutter.ephemeral": ["C:\\src\\wait_app\\linux\\flutter\\ephemeral"],
    "macos.Flutter": ["C:\\src\\wait_app\\macos\\Flutter"],
    "macos.Runner": ["C:\\src\\wait_app\\macos\\Runner"],
    "macos.RunnerTests": ["C:\\src\\wait_app\\macos\\RunnerTests"],
    "macos.Flutter.ephemeral": ["C:\\src\\wait_app\\macos\\Flutter\\ephemeral"],
    "macos.Runner.Configs": ["C:\\src\\wait_app\\macos\\Runner\\Configs"],
    "web.icons": ["C:\\src\\wait_app\\web\\icons"],
    "windows.flutter": ["C:\\src\\wait_app\\windows\\flutter"],
    "windows.runner": ["C:\\src\\wait_app\\windows\\runner"],
    "windows.flutter.ephemeral": ["C:\\src\\wait_app\\windows\\flutter\\ephemeral"],
    "windows.runner.resources": ["C:\\src\\wait_app\\windows\\runner\\resources"],
}
PATH_PLACEHOLDER = "__editable__.wait_app-0.1.0.finder" + ".__path_hook__"


class _EditableFinder:  # MetaPathFinder
    @classmethod
    def find_spec(cls, fullname: str, path=None, target=None) -> ModuleSpec | None:  # type: ignore
        # Top-level packages and modules (we know these exist in the FS)
        if fullname in MAPPING:
            pkg_path = MAPPING[fullname]
            return cls._find_spec(fullname, Path(pkg_path))

        # Handle immediate children modules (required for namespaces to work)
        # To avoid problems with case sensitivity in the file system we delegate
        # to the importlib.machinery implementation.
        parent, _, child = fullname.rpartition(".")
        if parent and parent in MAPPING:
            return PathFinder.find_spec(fullname, path=[MAPPING[parent]])

        # Other levels of nesting should be handled automatically by importlib
        # using the parent path.
        return None

    @classmethod
    def _find_spec(cls, fullname: str, candidate_path: Path) -> ModuleSpec | None:
        init = candidate_path / "__init__.py"
        candidates = (candidate_path.with_suffix(x) for x in module_suffixes())
        for candidate in chain([init], candidates):
            if candidate.exists():
                return spec_from_file_location(fullname, candidate)
        return None


class _EditableNamespaceFinder:  # PathEntryFinder
    @classmethod
    def _path_hook(cls, path) -> type[_EditableNamespaceFinder]:
        if path == PATH_PLACEHOLDER:
            return cls
        raise ImportError

    @classmethod
    def _paths(cls, fullname: str) -> list[str]:
        paths = NAMESPACES[fullname]
        if not paths and fullname in MAPPING:
            paths = [MAPPING[fullname]]
        # Always add placeholder, for 2 reasons:
        # 1. __path__ cannot be empty for the spec to be considered namespace.
        # 2. In the case of nested namespaces, we need to force
        #    import machinery to query _EditableNamespaceFinder again.
        return [*paths, PATH_PLACEHOLDER]

    @classmethod
    def find_spec(cls, fullname: str, target=None) -> ModuleSpec | None:  # type: ignore
        if fullname in NAMESPACES:
            spec = ModuleSpec(fullname, None, is_package=True)
            spec.submodule_search_locations = cls._paths(fullname)
            return spec
        return None

    @classmethod
    def find_module(cls, _fullname) -> None:
        return None


def install():
    if not any(finder == _EditableFinder for finder in sys.meta_path):
        sys.meta_path.append(_EditableFinder)

    if not NAMESPACES:
        return

    if not any(hook == _EditableNamespaceFinder._path_hook for hook in sys.path_hooks):
        # PathEntryFinder is needed to create NamespaceSpec without private APIS
        sys.path_hooks.append(_EditableNamespaceFinder._path_hook)
    if PATH_PLACEHOLDER not in sys.path:
        sys.path.append(PATH_PLACEHOLDER)  # Used just to trigger the path hook
