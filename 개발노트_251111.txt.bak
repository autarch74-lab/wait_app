############################################

=== Wait 앱 개발 명세 (업데이트) ===

[프로젝트 개요]
- 앱 이름: Wait
- 버전: 0.1.0 (MVP)
- 목표: 다중 소스의 경제·정책 이슈와 지수를 수집해 Copilot 질의문을 자동 생성하고 클립보드로 복사하는 모바일 유틸리티
- 대상 플랫폼: iOS / Android (React Native / Expo 권장)
- 현재 상태: 로컬 개발 환경 정상화 완료; 단위·위젯 테스트 통과; PR 준비 단계

[핵심 기능 및 모듈]
- collector: RSS 및 API 기반 소스 수집; 상태값 IDLE / RUNNING / SUCCESS / FAILED / TIMEOUT
- parser: HTML/JSON 파싱, 메타 추출, 기본 정규화
- embedder: 문장 임베딩 생성 (sentence-transformers 권장)
- deduper: 임베딩 유사도 기반 중복 제거; 유사도 임계값 0.85 권장
- ranker: 중요도 산정(빈도, 출처 신뢰도, 최신성 가중치)
- filegen: 표준화된 r_index.txt, r_news.txt, q_frame.txt 생성
- clipboard: 모바일 클립보드 복사 및 토스트 알림

[우선순위]
1. 임베딩 기반 중복 제거 및 대표 문장 선택
2. 파일 포맷 표준화 및 filegen 구현
3. 백엔드 API 엔드포인트 구현 및 통합 테스트
4. 모바일 UI 통합 및 E2E 검증

[UI 설계 및 파일 포맷]
- 화면 구성
  - 홈: 체크박스(전체선택), 소스 토글(Kospi, Issue 등), 실행 버튼, 로그 출력, 복사 버튼
  - 결과 미리보기: 생성된 텍스트 파일 내용 표시 및 개별 항목 복사
- 디자인 가이드
  - 폰트: monospace
  - 색상: Material Blue 계열
  - 알림: 토스트(성공/실패/타임아웃)
- 파일 포맷 샘플
  - r_index.txt
    - # timestamp: 2025-11-10T18:00:00Z
    - KOSPI: 3,120.45; change: -0.45%; source: KoreaExchange
    - USD/KRW: 1,350.12; change: +0.12%; source: FXAPI
  - r_news.txt
    - # timestamp: 2025-11-10T18:00:00Z
    - [1] title: "경제 지표 발표로 시장 변동성 확대"
        summary: "한국의 소비자물가지수가 예상치를 상회..."
        link: https://news.example/article/123
        source: Yonhap; score: 0.87
  - q_frame.txt
    - # template: market_issue_query_v1
    - Query: "최근 24시간 내 주요 경제지표와 관련 뉴스 요약을 반영해, 투자자 관점에서 핵심 쟁점 3가지를 정리하고 권장 질의문을 생성해줘."
    - Placeholders: {indices}, {top_issues}, {time_window}

[API 및 데이터베이스 설계]
- 주요 엔드포인트
  - POST /api/collect/indices — 파라미터: sources[], force:boolean, timeout:int
  - POST /api/collect/news — 파라미터: sources[], dedupe:boolean
  - GET /api/status — 현재 작업 상태 반환
  - POST /api/generate — mode: indices|news|combined 및 템플릿 선택
- 에러 코드
  - 404 Not Found, 500 Server Error, 408 Timeout (기본 8초 제한, 필요 시 조정)
- 데이터 모델(우선 구현)
  - sources(id, name, type, config)
  - articles(id, title, summary, link, embed_vector, score, created_at)
  - indices(timestamp, items_json)
  - jobs(id, type, status, started_at, finished_at, meta)
  - logs(id, job_id, level, message, timestamp)
- 저장소 권장
  - 임베딩: vector DB 또는 Postgres + pgvector; 대규모 검색 시 Faiss 사용

[기술 스택, CI, 배포]
- 권장 스택
  - 백엔드: FastAPI (Python)
  - 임베딩: sentence-transformers + Faiss 또는 pgvector
  - 모바일: React Native / Expo
  - 캐시/큐: Redis
  - DB: Postgres
- 개발 도구
  - 코드 스타일: ESLint, Prettier, Black
  - 테스트: pytest, Flutter test
- CI 권장 구성
  - PR마다 flutter analyze, flutter test 자동 실행
  - 백엔드: pytest 및 통합 테스트 실행
  - 예시 워크플로 파일: .github/workflows/flutter-ci.yml (flutter analyze, flutter test 포함)
- 배포
  - 스테이징: Docker 이미지 + 간단 Health check
  - 프로덕션: 스테이징 검증 후 롤링 배포

[진행 현황]
- 완료된 항목
  - 개발 환경 안정화 및 flutter_tester 정상화
  - flutter analyze 통과
  - flutter test 모든 테스트 통과
  - 브랜치 feat/indices-modularize 원격 동기화
  - pubspec.lock EOL 정상화 확인
- 단기 계획 (1주)
  - PR 생성 및 코드 리뷰 진행
  - GitHub Actions 기본 워크플로 추가 및 PR에서 CI 트리거 확인
  - filegen 모듈로 r_index.txt, r_news.txt, q_frame.txt 자동 생성 구현
- 중기 계획 (2–3주)
  - 임베딩 기반 중복 제거 모듈 완성 및 유효성 검증(유사도 0.85 기준)
  - 백엔드 API 구현 및 통합 테스트 작성
  - 모바일 UI와 백엔드 통합, 클립보드 복사 동작 검증
- 장기 계획 (4주+)
  - 스테이징 배포 및 E2E 테스트
  - 모니터링/로깅 설정, 성능 튜닝(임베딩 검색 속도)
  - 정식 릴리즈 및 릴리즈 노트 작성

[리스크 및 대응]
- flutter_tester 재발: CI 환경의 TMP/TEMP 경로를 ASCII로 고정; SDK 폴더 예외 처리 권장
- 임베딩 품질: 임계값과 모델을 실험적으로 조정, QA 기준(파서 성공률 ≥ 95%) 유지
- 라인 엔딩 문제: .gitattributes로 LF 강제화 권장
- 런타임 의존성: CI와 개발 환경에 Visual C++ Redistributable 설치 여부 확인

[작업 항목 체크리스트]
- [x] 개발 환경 안정화 및 테스트 통과
- [ ] PR 생성 및 리뷰 요청
- [ ] GitHub Actions CI 추가 및 PR에서 CI 통과
- [ ] r_index.txt / r_news.txt / q_frame.txt 포맷 확정 및 filegen 구현
- [ ] 임베딩 기반 중복 제거 모듈 구현 및 성능 검증
- [ ] 백엔드 API 구현 및 통합 테스트
- [ ] 모바일 UI 통합 및 E2E 테스트
- [ ] 스테이징 배포 및 모니터링 설정
- [ ] 프로덕션 릴리즈 및 문서화

[즉시 실행 가능한 명령 예시]
- PR 웹 열기
  - Start-Process "https://github.com/autarch74-lab/wait_app/compare/main...feat/indices-modularize?expand=1"
- .gitattributes 추가 및 정규화 (권장)
  - *.dart text eol=lf
  - pubspec.lock text eol=lf
  - git add .gitattributes
  - git add --renormalize .
  - git commit -m "chore: normalize line endings"
  - git push origin feat/indices-modularize
- GitHub Actions 예시 (간단)
  - flutter pub get
  - flutter analyze
  - flutter test --no-pub --coverage

끝.

#####################################################
### 파일 트리 구조

```
gstock_droid/
├── mobile/
│   ├── pubspec.yaml
│   ├── lib/
│   │   ├── main.dart
│   │   ├── app.dart
│   │   ├── modules/
│   │   │   ├── embedder_dedupe.dart
│   │   │   ├── file_generator.dart
│   │   │   ├── indices_collector.dart
│   │   │   ├── report_builder.dart
│   │   │   └── rss_collector.dart
│   │   └── services/
│   ├── assets/
│   └── test/
│       ├── parser_json_test.dart
│       ├── global_index_service_test.dart
│       └── widget_test.dart
├── backend/
├── infra/
├── docs/
├── .gitattributes
├── .gitignore
└── .github/
```

---

### 루트 파일 설명

| **파일 경로** | **설명** |
|---|---|
| **README.md** | 프로젝트 개요, 설치 및 실행 가이드 한 줄 요약 |
| **.gitignore** | Git에서 제외할 파일/폴더 목록 |
| **.gitattributes** | 라인 엔딩 및 파일 속성 규칙; LF 강제화 설정 |
| **.github/workflows/flutter-ci.yml** | PR에서 실행될 CI 워크플로(Flutter analyze/test) |
| **docs/spec.md** | 전체 개발 명세서(업데이트된 Wait 앱 명세) |
| **docs/README_DEV.md** | 개발 환경 설정 및 로컬 실행 절차 요약 |

---

### mobile 디렉토리 파일 설명

| **파일 경로** | **설명** |
|---|---|
| **mobile/pubspec.yaml** | Flutter 패키지 의존성 및 메타데이터 |
| **mobile/lib/main.dart** | 앱 진입점; 라우팅 및 초기화 코드 |
| **mobile/lib/src/modules/collector.dart** | RSS/API 소스에서 원시 데이터 수집 로직 |
| **mobile/lib/src/modules/parser.dart** | 수집된 HTML/JSON 파싱 및 정규화 로직 |
| **mobile/lib/src/modules/embedder.dart** | 문장 임베딩 생성 인터페이스 및 호출 래퍼 |
| **mobile/lib/src/modules/deduper.dart** | 임베딩 유사도 기반 중복 제거 알고리즘(임계값 0.85) |
| **mobile/lib/src/modules/ranker.dart** | 중요도 산정 및 스코어링 로직 |
| **mobile/lib/src/modules/filegen.dart** | r_index.txt, r_news.txt, q_frame.txt 생성기 |
| **mobile/lib/src/ui/home_page.dart** | 홈 화면 UI 및 사용자 입력 처리 |
| **mobile/lib/src/ui/widgets.dart** | 재사용 위젯(체크박스, 로그뷰, 버튼 등) |
| **mobile/lib/src/services/clipboard_service.dart** | 클립보드 복사 및 토스트 알림 처리 |
| **mobile/assets/r_index.txt** | 생성된 지수 요약 샘플 파일(예시/테스트용) |
| **mobile/assets/r_news.txt** | 생성된 뉴스/이슈 요약 샘플 파일 |
| **mobile/assets/q_frame.txt** | 질의문 템플릿 샘플 파일 |
| **mobile/test/parser_json_test.dart** | 파서 유닛 테스트 |
| **mobile/test/global_index_service_test.dart** | 인덱스 서비스 통합/단위 테스트 |
| **mobile/test/widget_test.dart** | 위젯 테스트(플러터 테스트 러너 사용) |

---

### backend 디렉토리 파일 설명

| **파일 경로** | **설명** |
|---|---|
| **backend/api/main.py** | FastAPI 앱 진입점; 서버 실행 스크립트 |
| **backend/api/routes.py** | API 엔드포인트 정의(collect, status, generate) |
| **backend/api/schemas.py** | 요청/응답 Pydantic 스키마 정의 |
| **backend/workers/collector_worker.py** | 수집 작업을 비동기/스케줄로 실행하는 워커 |
| **backend/workers/embed_worker.py** | 임베딩 생성 및 벡터 DB 적재 워커 |
| **backend/requirements.txt** | Python 의존성 목록(sentence-transformers, fastapi 등) |
| **backend/Dockerfile** | 백엔드 컨테이너 이미지 빌드 스크립트 |
| **backend/docker-compose.yml** | 로컬 개발용 서비스 구성(backend, redis, postgres) |

---

### infra 디렉토리 파일 설명

| **파일 경로** | **설명** |
|---|---|
| **infra/docker/Dockerfile.backend** | 프로덕션/스테이징용 백엔드 Dockerfile 템플릿 |
| **infra/terraform/main.tf** | 인프라 프로비저닝(예: 클라우드 리소스) 기본 템플릿 |

---

### docs 및 테스트 산출물 설명

| **파일 경로** | **설명** |
|---|---|
| **docs/spec.md** | 업데이트된 개발 명세 전체 문서(요구사항, 설계, 일정) |
| **docs/README_DEV.md** | 개발자용 환경 설정, TMP/TEMP 이슈, VC++ 권장 안내 |
| **mobile/assets/r_index.txt** | 실제 생성되는 지수 파일 포맷 샘플; 배포 시 생성 대상 |
| **mobile/assets/r_news.txt** | 실제 생성되는 뉴스 파일 포맷 샘플 |
| **mobile/assets/q_frame.txt** | 질의문 템플릿 샘플 |

---

### 즉시 참고 포인트
- **테스트 관련 파일**: `mobile/test/*.dart`는 이미 통과된 테스트들입니다.
- **생성 파일**: `mobile/assets/r_index.txt`, `r_news.txt`, `q_frame.txt`는 `filegen` 모듈에서 자동 생성되는 표준 출력물입니다.
- **CI 파일**: `.github/workflows/flutter-ci.yml`을 통해 PR마다 `flutter analyze`와 `flutter test`가 실행되도록 설정 권장합니다.
#####################################################

### 현재 상태
- **분석 통과**: `flutter analyze` 통과.
- **테스트 통과**: `flutter test`에서 모든 테스트 통과.
- **브랜치 상태**: `feat/indices-modularize`가 원격과 동기화되어 있고 작업 트리는 깨끗함.

---

### 즉시 할 일
- **원격에 변경사항이 없다면 PR 생성으로 진행**: 브라우저에서 비교 페이지를 열어 PR을 만듦.
```powershell
Start-Process "https://github.com/autarch74-lab/wait_app/compare/main...feat/indices-modularize?expand=1"
```
- **GitHub CLI로 PR 생성(설치되어 있으면)**:
```powershell
gh pr create --base main --head feat/indices-modularize --title "feat: modular indices" --body "모듈화된 지수 수집 및 테스트 추가. 검증: flutter analyze, flutter test"
```
- **PR 템플릿(본문 예시)**
  **요약**: 모듈화된 지수 수집 기능 추가
  **변경사항**: 핵심 파일/모듈 목록; 테스트 추가 내역
  **검증**: `flutter analyze` 통과, `flutter test` 통과
  **리뷰 요청자**: 팀 리뷰어 지정

---

### PR 체크리스트
- **설명**: 변경 목적과 영향 범위 명확히 기재
- **테스트**: 모든 유닛/위젯 테스트 통과 여부 표시
- **CI**: PR에서 CI 빌드가 성공해야 병합 권장
- **리뷰어 및 라벨**: 적절한 리뷰어와 라벨 지정
- **머지 전략**: Squash and merge 권장 또는 팀 규칙에 따름

---

### 병합 및 브랜치 정리
- **로컬에서 병합 후 푸시(원하면)**:
```powershell
git checkout main
git pull origin main
git merge --no-ff feat/indices-modularize
git push origin main
```
- **브랜치 삭제**:
```powershell
git branch -d feat/indices-modularize
git push origin --delete feat/indices-modularize
```

---

### 환경 복원 및 권장 정리
- **임시 폴더 원복**:
```powershell
[Environment]::SetEnvironmentVariable('TMP',$null,'User')
[Environment]::SetEnvironmentVariable('TEMP',$null,'User')
```
- **안티바이러스**: 실시간 보호 다시 켜고 Flutter SDK 폴더 예외 추가
- **(선택) GitHub CLI 설치**:
```powershell
winget install --id GitHub.cli
```
- **권장 마무리**: 시스템 재부팅 후 PR 생성 및 CI 통과 확인

원하시면 지금 PR 페이지를 열어드리겠습니다.

#####################################################
################################################

- 현재시각 (고정값)
- 주요 이슈 (정책/금융 뉴스, 산업별 이슈, 글로벌 이슈)
- 주요 지수 (글로벌지수, 국내지수, 코스피 주요종목 실시간 가격)
- 고정 질의문
"고정 질의문
(가), (나) 아래 리포트는 반드시 현재시각 기준으로 작성할 것.
과거 지수 수준이나 표현은 사용하지 말고, 제시된 수치만 기준으로 작성할 것.
지수 표현(예: ‘4,100선 돌파’)은 반드시 제시된 수치와 일치하도록 작성할 것.
작성된 리포트 내 수치와 표현이 모두 현재시각 기준으로 일관되게 작성되었는지 검토하고, 불일치가 있다면 수정할 것.
(A) 당일 현재시각까지의 외국인/기관/개인 자금흐름 요약
(B) 당일 현재시각까지의 등락폭 큰 주요종목 및 배경 설명 (TOP10),(종목명, 현재가, 등락율, 특징)
(C) 당일 현재시각까지의 외국인·기관·개인 및 거래대금 상위 종목 요약 (TOP10),(종목명, 현재가, 등락율, 거래대금(억), 주요 수급 주체, 특징)
(D) 투자 시점 관찰 포인트 및 전략
(E) 오늘 코스피장 30분 단위로 자세히 분석
(F) 단기적으로 기술적 반등 가능성 높은 코스피 종목 TOP20(종목명, 현재가, 등락률, 전일대비, 목표가, 목표가대비, 기술적 포인트, 배경 요약)
(G) 내일 장 대응 전략

(가), (나), (A~(G) 까지  .txt 형식으로 보여줘."
(A) 각 분야별 현황(분야, 대표주, 상승/하락 추세, 익일 추세, 배경, 기타) (B) 투자 시점 관찰 포인트 및 전략 (C) 오늘 코스피장 30분 단위로 자세히 분석 (D) 단기적으로 기술적 반등 가능성 높은 코스피 종목 TOP20(종목명, 현재가, 등락률, 전일대비, 목표가, 목표가대비, 기술적 포인트, 배경 요약) (E) 내일 장 대응 전략


################################################

wsl --install
wsl --set-default-version 2
wsl --list --verbose


python -m pip install --upgrade pip
python -m pip install -r backend/requirements.txt
python -m pytest backend/tests -q -k "not integration"

#####################################################

pwsh -NoProfile -File .\scripts\remove-bom.ps1


# Get staged files
$staged = git diff --cached --name-only --diff-filter=ACM
if (-not $staged) { exit 0 }
$files = $staged -split "`n" | ForEach-Object { $_.Trim() } | Where-Object { $_ -ne "" }
foreach ($f in $files) {
  if ($f -match '\.(toml|cfg|py|md|txt)$') {
    if (-not (Test-Path $f)) { continue }
    $b = [System.IO.File]::ReadAllBytes($f)
    if ($b.Length -ge 3 -and $b[0] -eq 0xEF -and $b[1] -eq 0xBB -and $b[2] -eq 0xBF) {
      [System.IO.File]::WriteAllBytes($f, $b[3..($b.Length-1)])
      Write-Host "Removed BOM:" $f
      git add -- $f
    }
  }
}
exit 0

#####################################################

#####################################################
